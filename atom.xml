<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>路过看看</title>
  
  <subtitle>歇歇再走</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2020-09-04T08:09:41.168Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Yi Li</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Kata Container — VM with conatiner APIs</title>
    <link href="http://yoursite.com/2020/09/04/kata-container/"/>
    <id>http://yoursite.com/2020/09/04/kata-container/</id>
    <published>2020-09-04T07:24:23.000Z</published>
    <updated>2020-09-04T08:09:41.168Z</updated>
    
    <content type="html"><![CDATA[<h2 id="kata-environment"><a href="#kata-environment" class="headerlink" title="kata environment"></a>kata environment</h2><ul><li><p>install kata on centos7</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">source /etc/os-release</span><br><span class="line"></span><br><span class="line">sudo yum -y install yum-utils</span><br><span class="line"></span><br><span class="line">sudo -E yum-config-manager --add-repo <span class="string">"http://download.opensuse.org/repositories/home:/katacontainers:/releases:/$&#123;ARCH&#125;:/$&#123;BRANCH&#125;/CentOS_7/home:katacontainers:releases:$&#123;ARCH&#125;:$&#123;BRANCH&#125;.repo"</span></span><br><span class="line"></span><br><span class="line">e.g.</span><br><span class="line"></span><br><span class="line">sudo -E yum-config-manager --add-repo <span class="symbol">http:</span>/<span class="regexp">/download.opensuse.org/repositories</span><span class="regexp">/home:/katacontainers</span><span class="symbol">:/releases</span><span class="symbol">:/x86_64</span><span class="symbol">:/master/CentOS_7/home</span><span class="symbol">:katacontainers</span><span class="symbol">:releases</span><span class="symbol">:x86_64</span><span class="symbol">:master</span>.repo</span><br><span class="line"></span><br><span class="line">sudo -E yum -y install kata-runtime kata-proxy kata-shim</span><br></pre></td></tr></table></figure></li><li><p>check kata status</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kata-runtime kata-check</span><br><span class="line"></span><br><span class="line">System is capable of running Kata Containers</span><br><span class="line">System can currently create Kata Containers</span><br></pre></td></tr></table></figure></li><li><p>configure kata</p></li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kata-<span class="string">path:</span> <span class="regexp">/usr/</span>bin/kata-runtime</span><br><span class="line">kata-<span class="string">config:</span>  <span class="regexp">/usr/</span>share<span class="regexp">/defaults/</span>kata-containers/configuration.toml</span><br></pre></td></tr></table></figure><p><em>Sandbox_cgroup_only -&gt; true</em>  <a href="https://github.com/kata-containers/documentation/blob/74ebc0945ed33817f851c12a0dbf0c37632d161a/design/host-cgroups.md" target="_blank" rel="noopener">Host cgroup management<br>-include kata-qemu into kata cgroup taskset path</a></p><p><em>default_vcpus = -1</em>   <a href="https://github.com/kata-containers/documentation/blob/89120e8d8a6429bd631126c9bf32cefb17cd5652/design/vcpu-handling.md" target="_blank" rel="noopener">to let cpuset-cpus work</a></p><ul><li>running docker/pouch with kata,<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi  <span class="meta-keyword">/etc/</span>docker/daemon.json </span><br><span class="line">vi <span class="meta-keyword">/etc/</span>pouch/config.json</span><br></pre></td></tr></table></figure></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#docker daemon</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"runtimes"</span>: &#123;</span><br><span class="line">   <span class="attr">"kata-qemu"</span>: &#123;</span><br><span class="line">      <span class="attr">"path"</span>: <span class="string">"/usr/bin/kata-runtime"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pouch daemon</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"volume-config"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"network-config"</span>: &#123;</span><br><span class="line">        <span class="attr">"bridge-config"</span>: &#123;</span><br><span class="line">            <span class="attr">"bip"</span>: <span class="string">"192.168.38.1/24"</span>,</span><br><span class="line">            <span class="attr">"default-gateway"</span>: <span class="string">"192.168.38.1"</span>,</span><br><span class="line">            <span class="attr">"iptables"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"ipforward"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"userland-proxy"</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"cri-config"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"TLS"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"default-log-config"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"registry-service"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"add-runtime"</span>: &#123;</span><br><span class="line">        <span class="attr">"kata-qemu"</span>: &#123;</span><br><span class="line">            <span class="attr">"path"</span>: <span class="string">"/opt/kata/bin/kata-runtime"</span>,</span><br><span class="line">            <span class="attr">"runtimeArgs"</span>: <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>check current runtime<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker info</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line">runtimes runc,kata-qemu</span><br><span class="line"><span class="built_in">..</span>.</span><br></pre></td></tr></table></figure></li></ul><h2 id="kata-usage"><a href="#kata-usage" class="headerlink" title="kata usage"></a>kata usage</h2><ul><li><p>setting runtime when start a container, default runc</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">run</span> -d  -<span class="built_in">name</span> name1  <span class="comment">--runtime kata-qemu images1 cmd1</span></span><br></pre></td></tr></table></figure></li><li><p>default vcpu is 1 and default vmemory size is 2g, so you should setting when start a kata conatiner</p></li></ul><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">run</span> -d  -<span class="built_in">name</span> name1  <span class="comment">--runtime kata-qemu --cpus 8 -m 16g  images1 cmd1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">or</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">run</span> -d  -<span class="built_in">name</span> name1  <span class="comment">--runtime kata-qemu --cpu-period 100000 --cpu-quota 800000 -m 16g  images1 cmd1</span></span><br></pre></td></tr></table></figure><ul><li>if you want to use the cpuset-cpus, you should also –cpus or –cpu-quota first, otherwise core pining will fail</li></ul><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d  -name name1  --runtime kata-qemu --cpus <span class="number">8</span> --cpuset-cpus <span class="number">7</span><span class="number">-15</span> -m <span class="number">16</span>g  images1 cmd1</span><br></pre></td></tr></table></figure><ul><li>if you want to check core pining really works, you can enter the container<figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="keyword">exec</span> -it name1 /bin/bash   nproc</span><br><span class="line"></span><br><span class="line"><span class="number">8</span></span><br><span class="line"></span><br><span class="line">docker <span class="keyword">exec</span> -it name1 /bin/bash cat /<span class="keyword">proc</span>/self/status  |<span class="title"> grep</span> Cpus_allowed_list</span><br><span class="line"></span><br><span class="line">7-15</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;kata-environment&quot;&gt;&lt;a href=&quot;#kata-environment&quot; class=&quot;headerlink&quot; title=&quot;kata environment&quot;&gt;&lt;/a&gt;kata environment&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;insta
      
    
    </summary>
    
    
      <category term="pouch" scheme="http://yoursite.com/tags/pouch/"/>
    
      <category term="docker" scheme="http://yoursite.com/tags/docker/"/>
    
      <category term="kata" scheme="http://yoursite.com/tags/kata/"/>
    
      <category term="conatiner" scheme="http://yoursite.com/tags/conatiner/"/>
    
      <category term="perf" scheme="http://yoursite.com/tags/perf/"/>
    
      <category term="cgroup" scheme="http://yoursite.com/tags/cgroup/"/>
    
      <category term="cycles" scheme="http://yoursite.com/tags/cycles/"/>
    
      <category term="cpuset" scheme="http://yoursite.com/tags/cpuset/"/>
    
  </entry>
  
  <entry>
    <title>How to use perf-stat to collect event of both runc and runv environment</title>
    <link href="http://yoursite.com/2020/09/04/perf-stat/"/>
    <id>http://yoursite.com/2020/09/04/perf-stat/</id>
    <published>2020-09-04T05:24:23.000Z</published>
    <updated>2020-09-04T07:59:21.732Z</updated>
    
    <content type="html"><![CDATA[<h2 id="How-to-use-perf-stat"><a href="#How-to-use-perf-stat" class="headerlink" title="How to use perf stat"></a>How to use perf stat</h2><ul><li>basic usage <a href="https://man7.org/linux/man-pages/man1/perf-stat.1.html" target="_blank" rel="noopener">man-perf</a></li></ul><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">perf stat [-e &lt;EVENT&gt; | --event=EVENT] [-a] &lt;command&gt;</span><br><span class="line">perf stat [-e &lt;EVENT&gt; | --event=EVENT] [-a] — &lt;command&gt; <span class="meta">[&lt;options&gt;]</span></span><br><span class="line">perf stat [-e &lt;EVENT&gt; | --event=EVENT] [-a] record [-o file] — &lt;command&gt; <span class="meta">[&lt;options&gt;]</span></span><br></pre></td></tr></table></figure><ul><li><p>examples</p><ul><li><p>specify a PMU counter, and output every 5 seconds</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf <span class="built_in">stat</span> -e cycles -I 5000</span><br></pre></td></tr></table></figure></li><li><p>output to a file, and setting sep to ‘,’</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf stat -e cycles -o perf<span class="selector-class">.csv</span>  -x , -I <span class="number">5000</span></span><br></pre></td></tr></table></figure></li><li><p>if you want more details please use -vv</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf stat -e cycles -o perf<span class="selector-class">.csv</span>  -x , -I <span class="number">5000</span> -vv</span><br></pre></td></tr></table></figure></li><li><p>specify pid</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf stat -e cycles -o perf<span class="selector-class">.csv</span>  -x , -I <span class="number">5000</span>  -<span class="selector-tag">p</span> <span class="number">50082</span></span><br></pre></td></tr></table></figure></li><li><p>specify docker runc cgroup, also should with system mode “-a”</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf stat -e cycles -o perf.csv  -<span class="keyword">x</span> , -I <span class="number">5000</span> -G docker/b<span class="number">3</span>f<span class="number">9e0421</span>d<span class="number">084</span>a<span class="number">3</span>b<span class="number">02</span><span class="keyword">c</span><span class="number">811791214e932395</span>ed<span class="number">463560495</span><span class="keyword">ccc</span><span class="number">31e7</span>ce<span class="number">7</span>ead<span class="number">889</span>ac -a</span><br></pre></td></tr></table></figure></li><li><p>specify pouch runc cgroup, also should with system mode “-a”</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf stat -e cycles -o perf.csv  -<span class="keyword">x</span> , -I <span class="number">5000</span> -G <span class="keyword">default</span>/b<span class="number">3</span>f<span class="number">9e0421</span>d<span class="number">084</span>a<span class="number">3</span>b<span class="number">02</span><span class="keyword">c</span><span class="number">811791214e932395</span>ed<span class="number">463560495</span><span class="keyword">ccc</span><span class="number">31e7</span>ce<span class="number">7</span>ead<span class="number">889</span>ac -a</span><br></pre></td></tr></table></figure></li><li><p>specify docker runv cgroup, also should with system mode “-a”</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf stat -e cycles -o perf.csv  -<span class="keyword">x</span> , -I <span class="number">5000</span> -G docker/kata_b<span class="number">3</span>f<span class="number">9e0421</span>d<span class="number">084</span>a<span class="number">3</span>b<span class="number">02</span><span class="keyword">c</span><span class="number">811791214e932395</span>ed<span class="number">463560495</span><span class="keyword">ccc</span><span class="number">31e7</span>ce<span class="number">7</span>ead<span class="number">889</span>ac -a</span><br></pre></td></tr></table></figure></li></ul><p><em>check /sys/fs/cgroup/per_event/docker/xxx for cgroup path</em></p></li></ul><ul><li><p>no-aggr mode, so you can check details of every hyperthreading cores, this <strong>no-aggr</strong> shouldn’t work with cgroup or pid</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf stat -e cycles,instructions -o perf<span class="selector-class">.csv</span> -x , -I <span class="number">5000</span> -<span class="selector-tag">a</span> --no-aggr</span><br></pre></td></tr></table></figure></li><li><p>for multi-plexing using an event group(3 fix counters + 4 other counters,no more than 4, otherwise a new envent group,the fix counters should be rewrite),e.g. -e {e1,e2,e3} -G c1</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf stat -e '&#123;inst_retired.any,cpu_clk_unhalted.<span class="keyword">thread</span>,cpu_clk_unhalted.ref_tsc,longest_lat_cache.miss,offcore_requests_outstanding.l3_miss_demand_dat<span class="built_in">a_rd</span>,offcore_requests.l3_miss_demand_dat<span class="built_in">a_rd</span>&#125;' -o perf.csv  -x , -I <span class="number">5000</span> -G docker/b3f9e0421d084a3b02c811791214e932395ed463560495ccc31e7ce7ead889ac -<span class="literal">a</span></span><br></pre></td></tr></table></figure><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf stat -e '&#123;inst_retired.any,cpu_clk_unhalted.thread,cpu_clk_unhalted.ref_tsc,longest_lat_cache.miss,offcore_requests_outstanding.l<span class="number">3</span>_miss_demand_data_rd,offcore_requests.l<span class="number">3</span>_miss_demand_data_rd&#125;,&#123;inst_retired.any,cpu_clk_unhalted.thread,cpu_clk_unhalted.ref_tsc,dtlb_load_misses.walk_pending,dtlb_store_misses.walk_pending,itlb_misses.walk_pending:GH,ept.walk_pending&#125;' -o perf.csv  -<span class="keyword">x</span> , -I <span class="number">5000</span> -G docker/b<span class="number">3</span>f<span class="number">9e0421</span>d<span class="number">084</span>a<span class="number">3</span>b<span class="number">02</span><span class="keyword">c</span><span class="number">811791214e932395</span>ed<span class="number">463560495</span><span class="keyword">ccc</span><span class="number">31e7</span>ce<span class="number">7</span>ead<span class="number">889</span>ac -a</span><br></pre></td></tr></table></figure></li><li><p>if you want to collect more than one cgroups, you should rewrite same numbers of cgroups as counter groups, e.g. -e eg1,eg2,eg1,eg2 -G c1,c1,c2,c2,  e.g. -e eg1,eg2,eg3,eg1,eg2,eg3,eg1,eg2,eg3 -G c1,c1,c1,c2,c2,c2,c3,c3,c3</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol"> sudo perf stat -e '&#123;inst_retired.any:GH,cpu_clk_unhalted.thread:GH,cpu_clk_unhalted.ref_tsc:GH,longest_lat_cache.miss:GH,offcore_requests_outstanding.l3_miss_demand_data_rd:GH,offcore_requests.l3_miss_demand_data_rd:</span>GH&#125;,</span><br><span class="line"><span class="symbol">&#123;inst_retired.any:GH,cpu_clk_unhalted.thread:GH,cpu_clk_unhalted.ref_tsc:GH,dtlb_load_misses.walk_pending:GH,dtlb_store_misses.walk_pending:GH,itlb_misses.walk_pending:GH,ept.walk_pending:</span>GH&#125;,</span><br><span class="line"><span class="symbol">&#123;inst_retired.any:GH,cpu_clk_unhalted.thread:GH,cpu_clk_unhalted.ref_tsc:GH,longest_lat_cache.miss:GH,offcore_requests_outstanding.l3_miss_demand_data_rd:GH,offcore_requests.l3_miss_demand_data_rd:</span>GH&#125;,</span><br><span class="line"><span class="symbol">&#123;inst_retired.any:GH,cpu_clk_unhalted.thread:GH,cpu_clk_unhalted.ref_tsc:GH,dtlb_load_misses.walk_pending:GH,dtlb_store_misses.walk_pending:GH,itlb_misses.walk_pending:GH,ept.walk_pending:</span>GH&#125;' </span><br><span class="line">-G </span><br><span class="line">docker/kat<span class="built_in">a_6cb9fc1fdc013fbb9320e9051681f1f62f8b4367e5290ea372f134b17574dbf4</span>,</span><br><span class="line">docker/kat<span class="built_in">a_6cb9fc1fdc013fbb9320e9051681f1f62f8b4367e5290ea372f134b17574dbf4</span>,</span><br><span class="line">docker/kat<span class="built_in">a_6cb9fc1fdc013fbb9320e9051681f1f62f8b4367e5290ea372f134b17574dbf4</span>,</span><br><span class="line">docker/kat<span class="built_in">a_6cb9fc1fdc013fbb9320e9051681f1f62f8b4367e5290ea372f134b17574dbf4</span>,</span><br><span class="line">docker/kat<span class="built_in">a_6cb9fc1fdc013fbb9320e9051681f1f62f8b4367e5290ea372f134b17574dbf4</span>,</span><br><span class="line">docker/kat<span class="built_in">a_6cb9fc1fdc013fbb9320e9051681f1f62f8b4367e5290ea372f134b17574dbf4</span>,</span><br><span class="line">docker/kat<span class="built_in">a_6cb9fc1fdc013fbb9320e9051681f1f62f8b4367e5290ea372f134b17574dbf4</span>,</span><br><span class="line">docker/kat<span class="built_in">a_6cb9fc1fdc013fbb9320e9051681f1f62f8b4367e5290ea372f134b17574dbf4</span>,</span><br><span class="line">docker/kat<span class="built_in">a_6cb9fc1fdc013fbb9320e9051681f1f62f8b4367e5290ea372f134b17574dbf4</span>,</span><br><span class="line">docker/kat<span class="built_in">a_6cb9fc1fdc013fbb9320e9051681f1f62f8b4367e5290ea372f134b17574dbf4</span>,</span><br><span class="line">docker/kat<span class="built_in">a_6cb9fc1fdc013fbb9320e9051681f1f62f8b4367e5290ea372f134b17574dbf4</span>,</span><br><span class="line">docker/kat<span class="built_in">a_6cb9fc1fdc013fbb9320e9051681f1f62f8b4367e5290ea372f134b17574dbf4</span>,</span><br><span class="line">docker/kat<span class="built_in">a_6cb9fc1fdc013fbb9320e9051681f1f62f8b4367e5290ea372f134b17574dbf4</span>,</span><br><span class="line">docker/kat<span class="built_in">a_b3f9e0421d084a3b02c811791214e932395ed463560495ccc31e7ce7ead889ac</span>,</span><br><span class="line">docker/kat<span class="built_in">a_b3f9e0421d084a3b02c811791214e932395ed463560495ccc31e7ce7ead889ac</span>,</span><br><span class="line">docker/kat<span class="built_in">a_b3f9e0421d084a3b02c811791214e932395ed463560495ccc31e7ce7ead889ac</span>,</span><br><span class="line">docker/kat<span class="built_in">a_b3f9e0421d084a3b02c811791214e932395ed463560495ccc31e7ce7ead889ac</span>,</span><br><span class="line">docker/kat<span class="built_in">a_b3f9e0421d084a3b02c811791214e932395ed463560495ccc31e7ce7ead889ac</span>,</span><br><span class="line">docker/kat<span class="built_in">a_b3f9e0421d084a3b02c811791214e932395ed463560495ccc31e7ce7ead889ac</span>,</span><br><span class="line">docker/kat<span class="built_in">a_b3f9e0421d084a3b02c811791214e932395ed463560495ccc31e7ce7ead889ac</span>,</span><br><span class="line">docker/kat<span class="built_in">a_b3f9e0421d084a3b02c811791214e932395ed463560495ccc31e7ce7ead889ac</span>,</span><br><span class="line">docker/kat<span class="built_in">a_b3f9e0421d084a3b02c811791214e932395ed463560495ccc31e7ce7ead889ac</span>,</span><br><span class="line">docker/kat<span class="built_in">a_b3f9e0421d084a3b02c811791214e932395ed463560495ccc31e7ce7ead889ac</span>,</span><br><span class="line">docker/kat<span class="built_in">a_b3f9e0421d084a3b02c811791214e932395ed463560495ccc31e7ce7ead889ac</span>,</span><br><span class="line">docker/kat<span class="built_in">a_b3f9e0421d084a3b02c811791214e932395ed463560495ccc31e7ce7ead889ac</span>,</span><br><span class="line">docker/kat<span class="built_in">a_b3f9e0421d084a3b02c811791214e932395ed463560495ccc31e7ce7ead889ac</span></span><br><span class="line"></span><br><span class="line"> -<span class="literal">a</span> -I <span class="number">5000</span></span><br></pre></td></tr></table></figure><h2 id="The-differnce-between-perf-kvm-stat-and-perf-stat"><a href="#The-differnce-between-perf-kvm-stat-and-perf-stat" class="headerlink" title="The differnce between perf kvm stat and perf stat"></a>The differnce between <strong>perf kvm stat</strong> and <strong>perf stat</strong></h2><p><a href="https://man7.org/linux/man-pages/man2/perf_event_open.2.html" target="_blank" rel="noopener">perf_event_open manual </a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">perf_event_attr</span> &#123;</span></span><br><span class="line">              __u32 type;                 <span class="comment">/* Type of event */</span></span><br><span class="line">              __u32 size;                 <span class="comment">/* Size of attribute structure */</span></span><br><span class="line">              __u64 config;               <span class="comment">/* Type-specific configuration */</span></span><br><span class="line"></span><br><span class="line">              <span class="keyword">union</span> &#123;</span><br><span class="line">                  __u64 sample_period;    <span class="comment">/* Period of sampling */</span></span><br><span class="line">                  __u64 sample_freq;      <span class="comment">/* Frequency of sampling */</span></span><br><span class="line">              &#125;;</span><br><span class="line"></span><br><span class="line">              __u64 sample_type;  <span class="comment">/* Specifies values included in sample */</span></span><br><span class="line">              __u64 read_format;  <span class="comment">/* Specifies values returned in read */</span></span><br><span class="line"></span><br><span class="line">              __u64 disabled       : <span class="number">1</span>,   <span class="comment">/* off by default */</span></span><br><span class="line">                    inherit        : <span class="number">1</span>,   <span class="comment">/* children inherit it */</span></span><br><span class="line">                    pinned         : <span class="number">1</span>,   <span class="comment">/* must always be on PMU */</span></span><br><span class="line">                    exclusive      : <span class="number">1</span>,   <span class="comment">/* only group on PMU */</span></span><br><span class="line">                    exclude_user   : <span class="number">1</span>,   <span class="comment">/* don't count user */</span></span><br><span class="line">                    exclude_kernel : <span class="number">1</span>,   <span class="comment">/* don't count kernel */</span></span><br><span class="line">                    exclude_hv     : <span class="number">1</span>,   <span class="comment">/* don't count hypervisor */</span></span><br><span class="line">                    exclude_idle   : <span class="number">1</span>,   <span class="comment">/* don't count when idle */</span></span><br><span class="line">                    mmap           : <span class="number">1</span>,   <span class="comment">/* include mmap data */</span></span><br><span class="line">                    comm           : <span class="number">1</span>,   <span class="comment">/* include comm data */</span></span><br><span class="line">                    freq           : <span class="number">1</span>,   <span class="comment">/* use freq, not period */</span></span><br><span class="line">                    inherit_stat   : <span class="number">1</span>,   <span class="comment">/* per task counts */</span></span><br><span class="line">                    enable_on_exec : <span class="number">1</span>,   <span class="comment">/* next exec enables */</span></span><br><span class="line">                    task           : <span class="number">1</span>,   <span class="comment">/* trace fork/exit */</span></span><br><span class="line">                    watermark      : <span class="number">1</span>,   <span class="comment">/* wakeup_watermark */</span></span><br><span class="line">                    precise_ip     : <span class="number">2</span>,   <span class="comment">/* skid constraint */</span></span><br><span class="line">                    mmap_data      : <span class="number">1</span>,   <span class="comment">/* non-exec mmap data */</span></span><br><span class="line">                    sample_id_all  : <span class="number">1</span>,   <span class="comment">/* sample_type all events */</span></span><br><span class="line">                    exclude_host   : <span class="number">1</span>,   <span class="comment">/* don't count in host */</span></span><br><span class="line">                    exclude_guest  : <span class="number">1</span>,   <span class="comment">/* don't count in guest */</span></span><br><span class="line">                    exclude_callchain_kernel : <span class="number">1</span>,</span><br><span class="line">                                          <span class="comment">/* exclude kernel callchains */</span></span><br><span class="line">                    exclude_callchain_user   : <span class="number">1</span>,</span><br><span class="line">                                          <span class="comment">/* exclude user callchains */</span></span><br><span class="line">                    mmap2          :  <span class="number">1</span>,  <span class="comment">/* include mmap with inode data */</span></span><br><span class="line">                    comm_exec      :  <span class="number">1</span>,  <span class="comment">/* flag comm events that are</span></span><br><span class="line"><span class="comment">                                             due to exec */</span></span><br><span class="line">                    use_clockid    :  <span class="number">1</span>,  <span class="comment">/* use clockid for time fields */</span></span><br><span class="line">                    context_switch :  <span class="number">1</span>,  <span class="comment">/* context switch data */</span></span><br><span class="line"></span><br><span class="line">                    __reserved_1   : <span class="number">37</span>;</span><br></pre></td></tr></table></figure></li></ul><blockquote><pre><code>exclude_host (since Linux 3.2)       When conducting measurements that include processes running VM       instances (i.e., have executed a KVM_RUN ioctl(2)), only mea‐       sure events happening inside a guest instance.  This is only       meaningful outside the guests; this setting does not change       counts gathered inside of a guest.  Currently, this function‐       ality is x86 only.</code></pre></blockquote><blockquote><pre><code>exclude_guest (since Linux 3.2)         When conducting measurements that include processes running VM         instances (i.e., have executed a KVM_RUN ioctl(2)), do not         measure events happening inside guest instances.  This is only         meaningful outside the guests; this setting does not change         counts gathered inside of a guest.  Currently, this function‐         ality is x86 only.</code></pre></blockquote><p>if the containers are running at runv environment, for example <em>kata-qemu</em></p><p>for details,espically the <em>perf_event_attr</em> attributes <em>exclude_guest</em> and <em>exclude_host</em>.</p><p>some examples:</p><ul><li>perf stat exclude guest os(default),  the cycle value equals to 20*10^6, which is incorrect, see perf_stat_exclude_guest.log</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#perf stat -e cycles -a -I 1000 -vv -C 1 -p 54927 sleep 5</span><br><span class="line">Using CPUID GenuineIntel-6-55</span><br><span class="line">intel_pt default config: tsc,mtc,mtc_period=3,psb_period=3,pt,branch</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">perf_event_attr:</span><br><span class="line">  size                             112</span><br><span class="line">  sample_type                      IDENTIFIER</span><br><span class="line">  read_format                      TOTAL_TIME_ENABLED|TOTAL_TIME_RUNNING</span><br><span class="line">  disabled                         1</span><br><span class="line">  inherit                          1</span><br><span class="line">  exclude_guest                    1</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">sys_perf_event_open: pid 54927  cpu -1  group_fd -1  flags 0x8 = 3</span><br><span class="line">sys_perf_event_open: pid 54928  cpu -1  group_fd -1  flags 0x8 = 4</span><br><span class="line">sys_perf_event_open: pid 54931  cpu -1  group_fd -1  flags 0x8 = 5</span><br><span class="line">sys_perf_event_open: pid 54932  cpu -1  group_fd -1  flags 0x8 = 7</span><br><span class="line">sys_perf_event_open: pid 54957  cpu -1  group_fd -1  flags 0x8 = 8</span><br><span class="line">cycles: 0: 163568 54163 54163</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 10762722 548684965 548684965</span><br><span class="line">cycles: 0: 9167118 450593782 450593782</span><br><span class="line">cycles: 20093408 999332910 999332910</span><br><span class="line">#           time             counts unit events</span><br><span class="line">     1.000140819         20,093,408      cycles</span><br><span class="line">cycles: 0: 329527 107629 107629</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 19858838 980411641 980411641</span><br><span class="line">cycles: 0: 20321440 1018679246 1018679246</span><br><span class="line">cycles: 20416397 999865606 999865606</span><br><span class="line">     2.000282256         20,416,397      cycles</span><br><span class="line">cycles: 0: 489050 159391 159391</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 30871376 1534625512 1534625512</span><br><span class="line">cycles: 0: 28979494 1463296617 1463296617</span><br><span class="line">cycles: 19830115 998883004 998883004</span><br></pre></td></tr></table></figure><ul><li>perf stat include guest, the cycle value close to 3200* 10^6, which is correct</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># perf stat -e cycles:GH -a -I 1000 -vv -C 1 -p 54927 sleep 5</span><br><span class="line">Using CPUID GenuineIntel-6-55</span><br><span class="line">intel_pt default config: tsc,mtc,mtc_period=3,psb_period=3,pt,branch</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">perf_event_attr:</span><br><span class="line">  size                             112</span><br><span class="line">  sample_type                      IDENTIFIER</span><br><span class="line">  read_format                      TOTAL_TIME_ENABLED|TOTAL_TIME_RUNNING</span><br><span class="line">  disabled                         1</span><br><span class="line">  inherit                          1</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">sys_perf_event_open: pid 54927  cpu -1  group_fd -1  flags 0x8 = 3</span><br><span class="line">sys_perf_event_open: pid 54928  cpu -1  group_fd -1  flags 0x8 = 4</span><br><span class="line">sys_perf_event_open: pid 54931  cpu -1  group_fd -1  flags 0x8 = 5</span><br><span class="line">sys_perf_event_open: pid 54932  cpu -1  group_fd -1  flags 0x8 = 7</span><br><span class="line">sys_perf_event_open: pid 54957  cpu -1  group_fd -1  flags 0x8 = 8</span><br><span class="line">cycles:GH: 0: 150607 49705 49705</span><br><span class="line">cycles:GH: 0: 0 0 0</span><br><span class="line">cycles:GH: 0: 0 0 0</span><br><span class="line">cycles:GH: 0: 1851603233 578636477 578636477</span><br><span class="line">cycles:GH: 0: 1349466048 421718356 421718356</span><br><span class="line">cycles:GH: 3201219888 1000404538 1000404538</span><br><span class="line">#           time             counts unit events</span><br><span class="line">     1.000141460      3,201,219,888      cycles:GH</span><br><span class="line">cycles:GH: 0: 318672 103892 103892</span><br><span class="line">cycles:GH: 0: 0 0 0</span><br><span class="line">cycles:GH: 0: 0 0 0</span><br><span class="line">cycles:GH: 0: 3186808454 995900872 995900872</span><br><span class="line">cycles:GH: 0: 3210871482 1003417209 1003417209</span><br><span class="line">cycles:GH: 3196778720 999017435 999017435</span><br><span class="line">     2.000294863      3,196,778,720      cycles:GH</span><br><span class="line">cycles:GH: 0: 473344 153881 153881</span><br><span class="line">cycles:GH: 0: 0 0 0</span><br><span class="line">cycles:GH: 0: 0 0 0</span><br><span class="line">cycles:GH: 0: 4914634282 1535858571 1535858571</span><br><span class="line">cycles:GH: 0: 4681607691 1463029297 1463029297</span><br><span class="line">cycles:GH: 3198716709 999619776 999619776</span><br></pre></td></tr></table></figure><ul><li>perf kvm stat exclude host, the cycle value close to 3180*10^6, which is incorrect, because it doesn’t include counters in host side</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># perf kvm  stat -e cycles -a -I 1000 -vv -C 1 -p 54927 sleep 5</span><br><span class="line">Using CPUID GenuineIntel-6-55</span><br><span class="line">intel_pt default config: tsc,mtc,mtc_period=3,psb_period=3,pt,branch</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">perf_event_attr:</span><br><span class="line">  size                             112</span><br><span class="line">  sample_type                      IDENTIFIER</span><br><span class="line">  read_format                      TOTAL_TIME_ENABLED|TOTAL_TIME_RUNNING</span><br><span class="line">  disabled                         1</span><br><span class="line">  inherit                          1</span><br><span class="line">  exclude_host                     1</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">sys_perf_event_open: pid 54927  cpu -1  group_fd -1  flags 0x8 = 3</span><br><span class="line">sys_perf_event_open: pid 54928  cpu -1  group_fd -1  flags 0x8 = 4</span><br><span class="line">sys_perf_event_open: pid 54931  cpu -1  group_fd -1  flags 0x8 = 5</span><br><span class="line">sys_perf_event_open: pid 54932  cpu -1  group_fd -1  flags 0x8 = 7</span><br><span class="line">sys_perf_event_open: pid 54957  cpu -1  group_fd -1  flags 0x8 = 8</span><br><span class="line">cycles: 0: 0 50959 50959</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 1876040767 589985556 589985556</span><br><span class="line">cycles: 0: 1302552550 409661083 409661083</span><br><span class="line">cycles: 3178593317 999697598 999697598</span><br><span class="line">#           time             counts unit events</span><br><span class="line">     1.000144669      3,178,593,317      cycles</span><br><span class="line">cycles: 0: 0 104610 104610</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 3258715492 1024938302 1024938302</span><br><span class="line">cycles: 0: 3099070031 974456233 974456233</span><br><span class="line">cycles: 3179192206 999801547 999801547</span><br><span class="line">     2.000287034      3,179,192,206      cycles</span><br><span class="line">cycles: 0: 0 154490 154490</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 5007308322 1574833169 1574833169</span><br><span class="line">cycles: 0: 4529377308 1424182546 1424182546</span><br><span class="line">cycles: 3178900107 999671060 999671060</span><br></pre></td></tr></table></figure><ul><li>perf kvm stat include host, the cycle value close to 3200*10^6, which is equal to perf stat include guest</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># perf kvm --host --guest  stat -e cycles -a -I 1000 -vv -C 1 -p 54927 sleep 5</span><br><span class="line">Using CPUID GenuineIntel-6-55</span><br><span class="line">intel_pt default config: tsc,mtc,mtc_period=3,psb_period=3,pt,branch</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">perf_event_attr:</span><br><span class="line">  size                             112</span><br><span class="line">  sample_type                      IDENTIFIER</span><br><span class="line">  read_format                      TOTAL_TIME_ENABLED|TOTAL_TIME_RUNNING</span><br><span class="line">  disabled                         1</span><br><span class="line">  inherit                          1</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">sys_perf_event_open: pid 54927  cpu -1  group_fd -1  flags 0x8 = 3</span><br><span class="line">sys_perf_event_open: pid 54928  cpu -1  group_fd -1  flags 0x8 = 4</span><br><span class="line">sys_perf_event_open: pid 54931  cpu -1  group_fd -1  flags 0x8 = 5</span><br><span class="line">sys_perf_event_open: pid 54932  cpu -1  group_fd -1  flags 0x8 = 7</span><br><span class="line">sys_perf_event_open: pid 54957  cpu -1  group_fd -1  flags 0x8 = 8</span><br><span class="line">cycles: 0: 156465 51514 51514</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 1697781991 530571505 530571505</span><br><span class="line">cycles: 0: 1501254716 469153401 469153401</span><br><span class="line">cycles: 3199193172 999776420 999776420</span><br><span class="line">#           time             counts unit events</span><br><span class="line">     1.000134636      3,199,193,172      cycles</span><br><span class="line">cycles: 0: 324906 105797 105797</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 3069636439 959290212 959290212</span><br><span class="line">cycles: 0: 3328363931 1040133163 1040133163</span><br><span class="line">cycles: 3199132104 999752752 999752752</span><br><span class="line">     2.000277464      3,199,132,104      cycles</span><br><span class="line">cycles: 0: 482160 156477 156477</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 0 0 0</span><br><span class="line">cycles: 0: 4697639841 1468050819 1468050819</span><br><span class="line">cycles: 0: 4898815012 1530907460 1530907460</span><br><span class="line">cycles: 3198611737 999585584 999585584</span><br></pre></td></tr></table></figure><p>So, if you feel uncomfortable to use <em>perf kvm stat –host</em> on runv environment, you can use <em>perf stat -e event_name:GH</em> instead, although the results should be same.<br>If the containers are running at runc environment, don’t worry about it, just use <strong>perf stat</strong></p><h2 id="sar-is-also-a-good-tool-to-collect-performance"><a href="#sar-is-also-a-good-tool-to-collect-performance" class="headerlink" title="sar is also a good tool to collect performance"></a>sar is also a good tool to collect performance</h2><p>same as perf+no-aggr on utilization </p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sar -P <span class="built_in">ALL</span> -o sar.<span class="keyword">data</span></span><br></pre></td></tr></table></figure><p>transfer the binary data into unix-format readable data</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">sadf</span> <span class="selector-tag">-d</span> <span class="selector-tag">-P</span> <span class="selector-tag">ALL</span>  <span class="selector-tag">sar</span><span class="selector-class">.data</span> &gt; <span class="selector-tag">sar</span><span class="selector-class">.csv</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;How-to-use-perf-stat&quot;&gt;&lt;a href=&quot;#How-to-use-perf-stat&quot; class=&quot;headerlink&quot; title=&quot;How to use perf stat&quot;&gt;&lt;/a&gt;How to use perf stat&lt;/h2&gt;&lt;
      
    
    </summary>
    
    
      <category term="pouch" scheme="http://yoursite.com/tags/pouch/"/>
    
      <category term="docker" scheme="http://yoursite.com/tags/docker/"/>
    
      <category term="kata" scheme="http://yoursite.com/tags/kata/"/>
    
      <category term="conatiner" scheme="http://yoursite.com/tags/conatiner/"/>
    
      <category term="perf" scheme="http://yoursite.com/tags/perf/"/>
    
      <category term="sar" scheme="http://yoursite.com/tags/sar/"/>
    
      <category term="cgroup" scheme="http://yoursite.com/tags/cgroup/"/>
    
      <category term="cycles" scheme="http://yoursite.com/tags/cycles/"/>
    
  </entry>
  
  <entry>
    <title>Cross host container communication by swarm</title>
    <link href="http://yoursite.com/2020/09/04/container-communication-coss-host-by-swarm/"/>
    <id>http://yoursite.com/2020/09/04/container-communication-coss-host-by-swarm/</id>
    <published>2020-09-04T01:54:13.000Z</published>
    <updated>2020-09-04T07:23:45.488Z</updated>
    
    <content type="html"><![CDATA[<ul><li>start swarm service on server 1<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker swarm init</span></span><br></pre></td></tr></table></figure></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">docker</span> <span class="string">info</span> </span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">Swarm:</span> <span class="string">active</span></span><br><span class="line"><span class="attr"> NodeID:</span> <span class="string">mjlxz2xwr8n4nd8pr4abs90cf</span></span><br><span class="line"> <span class="string">Is</span> <span class="attr">Manager:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr"> ClusterID:</span> <span class="string">mlbjnejhau2knc9octau5idnn</span></span><br><span class="line"><span class="attr"> Managers:</span> <span class="number">1</span></span><br><span class="line"><span class="attr"> Nodes:</span> <span class="number">4</span></span><br><span class="line"><span class="attr"> Orchestration:</span></span><br><span class="line">  <span class="string">Task</span> <span class="string">History</span> <span class="string">Retention</span> <span class="attr">Limit:</span> <span class="number">5</span></span><br><span class="line"><span class="attr"> Raft:</span></span><br><span class="line">  <span class="string">Snapshot</span> <span class="attr">Interval:</span> <span class="number">10000</span></span><br><span class="line">  <span class="string">Number</span> <span class="string">of</span> <span class="string">Old</span> <span class="string">Snapshots</span> <span class="string">to</span> <span class="attr">Retain:</span> <span class="number">0</span></span><br><span class="line">  <span class="string">Heartbeat</span> <span class="attr">Tick:</span> <span class="number">1</span></span><br><span class="line">  <span class="string">Election</span> <span class="attr">Tick:</span> <span class="number">10</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><ul><li>create an <strong>overaly</strong> network</li></ul><p>To create an overlay network for use with swarm services, use a command like the following:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker<span class="built_in"> network </span>create -d overlay my-overlay</span><br></pre></td></tr></table></figure><p>To create an overlay network which can be used by swarm services or standalone containers to communicate with other standalone containers running on other Docker daemons, add the <em>–attachable</em> flag:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker<span class="built_in"> network </span>create -d overlay --attachable </span><br><span class="line">my-attachable-overlay</span><br></pre></td></tr></table></figure><h2 id="other-servers"><a href="#other-servers" class="headerlink" title="other servers"></a>other servers</h2><ul><li>join the swarm</li></ul><p>docker swarm join –token SWMTKN-1-3vyjwjv6inlxr0wv1mmibbwzo5qt6cmultg2losufxd0nbi6z5-7veb80yv1im6ii8oma5q1k1s4 172.16.190.79:2377</p><p>then you can find server2 automatically join the overlay net</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">780463da98af        bridge              bridge              <span class="built_in">local</span></span><br><span class="line">d0e6aefdfb8a        docker_gwbridge     bridge              <span class="built_in">local</span></span><br><span class="line">d45984c66fd5        host                host                <span class="built_in">local</span></span><br><span class="line">jaf4kx0gku62        ingress             overlay             swarm</span><br><span class="line">20855b96e0b1        none                null                <span class="built_in">local</span></span><br><span class="line">6qmeomevipgt     my-attachable-overlay  overlay             swarm</span><br></pre></td></tr></table></figure><p>and you can check in server1</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="selector-tag">docker</span> <span class="selector-tag">node</span> <span class="selector-tag">ls</span></span><br><span class="line"><span class="selector-tag">ID</span>                            <span class="selector-tag">HOSTNAME</span>                  <span class="selector-tag">STATUS</span>              <span class="selector-tag">AVAILABILITY</span>        <span class="selector-tag">MANAGER</span> <span class="selector-tag">STATUS</span>      <span class="selector-tag">ENGINE</span> <span class="selector-tag">VERSION</span></span><br><span class="line"><span class="selector-tag">mjlxz2xwr8n4nd8pr4abs90cf</span> *   <span class="selector-tag">iZbp1bzbzd1dmznk9xxxxxx</span>   <span class="selector-tag">Ready</span>               <span class="selector-tag">Active</span>              <span class="selector-tag">Leader</span>              18<span class="selector-class">.06</span><span class="selector-class">.0-ce</span></span><br><span class="line"><span class="selector-tag">uf041tg0obzprppredut27bgg</span>     <span class="selector-tag">iZbp1bzbzd1dmznk9xxxxxx</span>   <span class="selector-tag">Ready</span>               <span class="selector-tag">Active</span>                                  18<span class="selector-class">.06</span><span class="selector-class">.0-ce</span></span><br><span class="line"><span class="selector-tag">t3380b55qfen3fdtoj10x8lcf</span>     <span class="selector-tag">iZbp1bzbzd1dmznk9xxxxxx</span>   <span class="selector-tag">Ready</span>               <span class="selector-tag">Active</span>                                  18<span class="selector-class">.06</span><span class="selector-class">.0-ce</span></span><br><span class="line"><span class="selector-tag">gzzalp8thajd0w55rrm5pvv3z</span>     <span class="selector-tag">iZbp1bzbzd1dmznk9xxxxxx</span>   <span class="selector-tag">Ready</span>               <span class="selector-tag">Active</span>                                  18<span class="selector-class">.06</span><span class="selector-class">.0-ce</span></span><br></pre></td></tr></table></figure><ul><li>start container with the overlay net on server2</li></ul><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">docker</span> <span class="comment">run</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">name</span> <span class="comment">test1</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">hostname</span> <span class="comment">name1</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">runtime</span> <span class="comment">runc</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">net=my</span><span class="literal">-</span><span class="comment">attachable</span><span class="literal">-</span><span class="comment">overlay</span></span><br><span class="line"><span class="comment"></span> <span class="literal">-</span><span class="literal">-</span><span class="comment">ulimit</span> <span class="comment">nofile=102400:102400</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">cpus</span> <span class="comment">30</span> <span class="literal">-</span><span class="comment">d</span> <span class="literal">-</span><span class="comment">P</span> <span class="literal">-</span><span class="comment">p</span> <span class="comment">50070:50070</span> <span class="literal">-</span><span class="comment">p</span> <span class="comment">8088:8088</span>  <span class="comment">docker</span><span class="literal">-</span><span class="comment">images1</span></span><br></pre></td></tr></table></figure><p>Now, containers on servers2 can access containers on server1</p><ul><li><p>server2 can also leave  swarm node </p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker swarm leave</span></span><br></pre></td></tr></table></figure></li><li><p>when alll the nodes leave swarm node,server 1 can stop/remove swarm</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker swarm leave</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h3><ul><li><p><a href="https://docs.docker.com/engine/reference/commandline/swarm_init/" target="_blank" rel="noopener">docker swarm doc</a></p></li><li><p><a href="https://docs.docker.com/network/overlay/" target="_blank" rel="noopener">docker network doc</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ul&gt;
&lt;li&gt;start swarm service on server 1&lt;figure class=&quot;highlight ebnf&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/p
      
    
    </summary>
    
    
      <category term="etcd" scheme="http://yoursite.com/tags/etcd/"/>
    
      <category term="flannel" scheme="http://yoursite.com/tags/flannel/"/>
    
      <category term="overlay" scheme="http://yoursite.com/tags/overlay/"/>
    
      <category term="docker" scheme="http://yoursite.com/tags/docker/"/>
    
      <category term="swarm" scheme="http://yoursite.com/tags/swarm/"/>
    
      <category term="container" scheme="http://yoursite.com/tags/container/"/>
    
  </entry>
  
  <entry>
    <title>Cross host container communication by flannel</title>
    <link href="http://yoursite.com/2020/09/02/container-communication-corss-host-by-flannel/"/>
    <id>http://yoursite.com/2020/09/02/container-communication-corss-host-by-flannel/</id>
    <published>2020-09-02T07:54:13.000Z</published>
    <updated>2020-09-04T07:23:35.514Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/alibaba/pouch" target="_blank" rel="noopener">pouch container</a> doesn’t support <strong>swarm</strong> mode, so you can’t use <strong>docker swarm</strong> advantages to build <strong>overlay</strong> network if you lxc environment is pouch or sth else</p><ul><li><p>install flannel on each server</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> flannel -y</span><br></pre></td></tr></table></figure></li><li><p>config flannel etcd url</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/flanneld</span><br></pre></td></tr></table></figure></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Flanneld configuration options</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># etcd url location.  Point this to the server where etcd runs</span></span><br><span class="line"><span class="string">FLANNEL_ETCD_ENDPOINTS="http://172.16.190.73:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># etcd config key.  This is the configuration key that flannel queries</span></span><br><span class="line"><span class="comment"># For address range assignment</span></span><br><span class="line"><span class="string">FLANNEL_ETCD_PREFIX="/atomic.io/network"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Any additional options that you want to pass</span></span><br><span class="line"><span class="comment">#FLANNEL_OPTIONS=""</span></span><br></pre></td></tr></table></figure><ul><li>remeber to set the container ip range on etcd server</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl <span class="keyword">set</span> /atomic.io/network/config '&#123; <span class="string">"Network"</span>: <span class="string">"192.168.0.0/16"</span> &#125;<span class="string">'</span></span><br></pre></td></tr></table></figure><p>  or</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec yl-etcd   etcdctl <span class="keyword">set</span> /atomic.io/network/config '&#123; <span class="string">"Network"</span>: <span class="string">"192.168.0.0/16"</span> &#125;<span class="string">'</span></span><br></pre></td></tr></table></figure><ul><li><p>start service</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="builtin-name">enable</span> flanneld</span><br><span class="line">systemctl start flanneld</span><br></pre></td></tr></table></figure></li><li><p>config pouch or docker, update gateway</p></li></ul><p>pouch doesn’t support swarm, so we use pouch container mannager as example</p><p>start pouchd or dockerd</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /<span class="keyword">run</span><span class="bash">/flannel/subnet.env</span></span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat /run/flannel/subnet.env</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line"><span class="attribute">FLANNEL_NETWORK</span>=192.168.0.0/16</span><br><span class="line"><span class="attribute">FLANNEL_SUBNET</span>=192.168.38.1/24</span><br><span class="line"><span class="attribute">FLANNEL_MTU</span>=1472</span><br><span class="line"><span class="attribute">FLANNEL_IPMASQ</span>=<span class="literal">false</span></span><br><span class="line"><span class="built_in">..</span>.</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop pouch</span><br><span class="line"></span><br><span class="line">pouchd --bip=<span class="variable">$&#123;FLANNEL_SUBNET&#125;</span> --mtu=<span class="variable">$&#123;FLANNEL_MTU&#125;</span> --default-gateway 192.168.38.1 &amp;</span><br><span class="line"></span><br><span class="line">pouchd --bip=<span class="variable">$&#123;FLANNEL_SUBNET&#125;</span> --mtu=<span class="variable">$&#123;FLANNEL_MTU&#125;</span> --default-gateway 192.168.65.1 &amp;</span><br></pre></td></tr></table></figure><p>or you can update pouchd or dockerd <a href="https://github.com/alibaba/pouch/blob/master/docs/commandline/pouch_updatedaemon.md" target="_blank" rel="noopener">update pouch daemon</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pouch updatedaemon --debug=<span class="literal">true</span> --bip=<span class="variable">$&#123;FLANNEL_SUBNET&#125;</span> --mtu=<span class="variable">$&#123;FLANNEL_MTU&#125;</span> --default-gateway 192.168.38.1 </span><br><span class="line"></span><br><span class="line">pouch updatedaemon --bip 192.168.38.1/24 --default-gateway 192.168.38.1 --offline=<span class="literal">true</span></span><br></pre></td></tr></table></figure><p>or you can update the default config and restart pouch</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"volume-config"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"network-config"</span>: &#123;</span><br><span class="line">        <span class="attr">"bridge-config"</span>: &#123;</span><br><span class="line">            <span class="attr">"bip"</span>: <span class="string">"192.168.38.1/24"</span>,</span><br><span class="line">            <span class="attr">"default-gateway"</span>: <span class="string">"192.168.38.1"</span>,</span><br><span class="line">            <span class="attr">"iptables"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"ipforward"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"userland-proxy"</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"cri-config"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"TLS"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"default-log-config"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"registry-service"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"add-runtime"</span>: &#123;</span><br><span class="line">        <span class="attr">"runv"</span>: &#123;</span><br><span class="line">            <span class="attr">"path"</span>: <span class="string">"/opt/kata/bin/kata-runtime"</span>,</span><br><span class="line">            <span class="attr">"runtimeArgs"</span>: <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>for each host, update ip tables input and output rules</li></ul><figure class="highlight tp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -<span class="keyword">P</span> INPUT <span class="keyword">ACC</span>EPT</span><br><span class="line">iptables -<span class="keyword">P</span> FORWARD <span class="keyword">ACC</span>EPT</span><br><span class="line">iptables -F</span><br><span class="line">iptables -L -n</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://github.com/alibaba/pouch&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;pouch container&lt;/a&gt; doesn’t support &lt;strong&gt;swarm&lt;/strong&gt; mode
      
    
    </summary>
    
    
      <category term="etcd" scheme="http://yoursite.com/tags/etcd/"/>
    
      <category term="flannel" scheme="http://yoursite.com/tags/flannel/"/>
    
      <category term="overlay" scheme="http://yoursite.com/tags/overlay/"/>
    
      <category term="pouch" scheme="http://yoursite.com/tags/pouch/"/>
    
      <category term="docker" scheme="http://yoursite.com/tags/docker/"/>
    
      <category term="container" scheme="http://yoursite.com/tags/container/"/>
    
  </entry>
  
  <entry>
    <title>etcd</title>
    <link href="http://yoursite.com/2020/09/02/etcd/"/>
    <id>http://yoursite.com/2020/09/02/etcd/</id>
    <published>2020-09-02T07:29:24.000Z</published>
    <updated>2020-09-04T01:26:14.444Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Start-a-etcd"><a href="#Start-a-etcd" class="headerlink" title="Start  a etcd"></a>Start  a etcd</h1><p>clean data</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /tmp/etcd-data.tmp</span><br></pre></td></tr></table></figure><p>deploy etcd</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">  -d \</span><br><span class="line">  -p 2379:2379 \</span><br><span class="line">  -p 2380:2380 \</span><br><span class="line">  -p 4001:4001 \</span><br><span class="line">  -p 7001:7001 \</span><br><span class="line">  -v /tmp/etcd-data.tmp:/etcd-data \</span><br><span class="line">  --name yl-etcd \</span><br><span class="line">  elcolio/etcd:latest \</span><br><span class="line"> --name s1    --data-dir /etcd-data    --listen-client-urls http://0.0.0.0:2379    --advertise-client-urls http://0.0.0.0:2379    --listen-peer-urls http://0.0.0.0:2380    --initial-advertise-peer-urls http://0.0.0.0:2380    --initial-cluster s1=http://0.0.0.0:2380    --initial-cluster-token tkn    --initial-cluster-state new</span><br></pre></td></tr></table></figure><p>set some key-value store, and test get</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> yl-etcd   etcdctl <span class="built_in">set</span> /atomic.io/network/config <span class="string">'&#123; "Network": "192.168.0.0/16" &#125;'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> yl-etcd   etcdctl get /atomic.io/network/config</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Start-a-etcd&quot;&gt;&lt;a href=&quot;#Start-a-etcd&quot; class=&quot;headerlink&quot; title=&quot;Start  a etcd&quot;&gt;&lt;/a&gt;Start  a etcd&lt;/h1&gt;&lt;p&gt;clean data&lt;/p&gt;
&lt;figure class
      
    
    </summary>
    
    
      <category term="etcd" scheme="http://yoursite.com/tags/etcd/"/>
    
      <category term="flannel" scheme="http://yoursite.com/tags/flannel/"/>
    
  </entry>
  
  <entry>
    <title>avx512</title>
    <link href="http://yoursite.com/2019/06/21/avx512/"/>
    <id>http://yoursite.com/2019/06/21/avx512/</id>
    <published>2019-06-21T05:31:00.000Z</published>
    <updated>2020-09-02T07:35:03.942Z</updated>
    
    <content type="html"><![CDATA[<p>dasds</p><p>scdscds</p><p>xscsd</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;dasds&lt;/p&gt;
&lt;p&gt;scdscds&lt;/p&gt;
&lt;p&gt;xscsd&lt;/p&gt;

      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>kaggle</title>
    <link href="http://yoursite.com/2019/06/21/kaggle/"/>
    <id>http://yoursite.com/2019/06/21/kaggle/</id>
    <published>2019-06-21T05:30:47.000Z</published>
    <updated>2019-06-21T05:30:47.787Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>git</title>
    <link href="http://yoursite.com/2019/06/21/git/"/>
    <id>http://yoursite.com/2019/06/21/git/</id>
    <published>2019-06-21T05:29:35.000Z</published>
    <updated>2019-06-21T05:29:35.487Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>docker</title>
    <link href="http://yoursite.com/2019/06/21/docker/"/>
    <id>http://yoursite.com/2019/06/21/docker/</id>
    <published>2019-06-21T05:29:09.000Z</published>
    <updated>2019-06-21T05:29:09.132Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>xgboost</title>
    <link href="http://yoursite.com/2019/06/21/xgboost/"/>
    <id>http://yoursite.com/2019/06/21/xgboost/</id>
    <published>2019-06-21T05:22:25.000Z</published>
    <updated>2019-06-21T05:24:56.653Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
      <category term="boosting" scheme="http://yoursite.com/tags/boosting/"/>
    
  </entry>
  
  <entry>
    <title>LR</title>
    <link href="http://yoursite.com/2019/06/21/LR/"/>
    <id>http://yoursite.com/2019/06/21/LR/</id>
    <published>2019-06-21T05:21:42.000Z</published>
    <updated>2019-06-21T05:23:59.986Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
      <category term="ML" scheme="http://yoursite.com/tags/ML/"/>
    
  </entry>
  
  <entry>
    <title>IF</title>
    <link href="http://yoursite.com/2019/06/21/IF/"/>
    <id>http://yoursite.com/2019/06/21/IF/</id>
    <published>2019-06-21T05:21:28.000Z</published>
    <updated>2019-06-21T05:23:45.733Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
      <category term="Isolate Forest" scheme="http://yoursite.com/tags/Isolate-Forest/"/>
    
      <category term="Desion Tree" scheme="http://yoursite.com/tags/Desion-Tree/"/>
    
  </entry>
  
  <entry>
    <title>gdbt</title>
    <link href="http://yoursite.com/2019/06/21/gdbt/"/>
    <id>http://yoursite.com/2019/06/21/gdbt/</id>
    <published>2019-06-21T05:21:13.000Z</published>
    <updated>2019-06-27T06:10:07.686Z</updated>
    
    <content type="html"><![CDATA[<p>csdcdcsddsdcs<br><a href="www.abc.com">ddd</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;csdcdcsddsdcs&lt;br&gt;&lt;a href=&quot;www.abc.com&quot;&gt;ddd&lt;/a&gt;&lt;/p&gt;

      
    
    </summary>
    
    
      <category term="Desicion Tree" scheme="http://yoursite.com/tags/Desicion-Tree/"/>
    
  </entry>
  
  <entry>
    <title>RF</title>
    <link href="http://yoursite.com/2019/06/21/RF/"/>
    <id>http://yoursite.com/2019/06/21/RF/</id>
    <published>2019-06-21T05:20:17.000Z</published>
    <updated>2019-06-21T05:24:39.514Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
      <category term="ML" scheme="http://yoursite.com/tags/ML/"/>
    
      <category term="boosting" scheme="http://yoursite.com/tags/boosting/"/>
    
  </entry>
  
  <entry>
    <title>LSTM</title>
    <link href="http://yoursite.com/2019/06/21/LSTM/"/>
    <id>http://yoursite.com/2019/06/21/LSTM/</id>
    <published>2019-06-21T05:19:19.000Z</published>
    <updated>2019-06-21T05:24:16.267Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
      <category term="ML" scheme="http://yoursite.com/tags/ML/"/>
    
      <category term="NLP" scheme="http://yoursite.com/tags/NLP/"/>
    
  </entry>
  
  <entry>
    <title>EM</title>
    <link href="http://yoursite.com/2019/06/21/EM/"/>
    <id>http://yoursite.com/2019/06/21/EM/</id>
    <published>2019-06-21T05:18:59.000Z</published>
    <updated>2019-06-21T05:22:53.411Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
      <category term="ML" scheme="http://yoursite.com/tags/ML/"/>
    
      <category term="Bayesian" scheme="http://yoursite.com/tags/Bayesian/"/>
    
  </entry>
  
  <entry>
    <title>prometheus</title>
    <link href="http://yoursite.com/2019/06/21/prometheus/"/>
    <id>http://yoursite.com/2019/06/21/prometheus/</id>
    <published>2019-06-21T05:14:21.000Z</published>
    <updated>2019-06-24T03:03:10.943Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Prometheus-start-by-docker"><a href="#Prometheus-start-by-docker" class="headerlink" title="Prometheus start by docker"></a>Prometheus start by docker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 9090:9090 --name prometheus  -d -v /home/li/Downloads/prom/Prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus</span><br></pre></td></tr></table></figure><h2 id="设置mount"><a href="#设置mount" class="headerlink" title="设置mount"></a>设置mount</h2><p> -v 将local <em>Promethus.yml</em> 和 <em>/etc/prometheus/prometheus.yml</em> 文件挂载</p><p> 这样可以custom configure local pro.yml </p><ul><li><p>for example 设置</p><p> 一个 target 来源为json file<br> <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#file_sd_config" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#file_sd_config</a></p></li></ul><ul><li>for example 设置static<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">       │ File: Prometheus.yml</span><br><span class="line">───────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">   1   │ # my global config</span><br><span class="line">   2   │ global:</span><br><span class="line">   3   │   scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">   4   │   evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">   5   │   # scrape_timeout is set to the global default (10s).</span><br><span class="line">   6   │</span><br><span class="line">   7   │ # Alertmanager configuration</span><br><span class="line">   8   │ alerting:</span><br><span class="line">   9   │   alertmanagers:</span><br><span class="line">  10   │   - static_configs:</span><br><span class="line">  11   │     - targets:</span><br><span class="line">  12   │       # - alertmanager:9093</span><br><span class="line">  13   │</span><br><span class="line">  14   │ # Load rules once and periodically evaluate them according to the global &apos;evaluation_interval&apos;.</span><br><span class="line">  15   │ rule_files:</span><br><span class="line">  16   │   # - &quot;first_rules.yml&quot;</span><br><span class="line">  17   │   # - &quot;second_rules.yml&quot;</span><br><span class="line">  18   │</span><br><span class="line">  19   │ # A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line">  20   │ # Here it&apos;s Prometheus itself.</span><br><span class="line">  21   │ scrape_configs:</span><br><span class="line">  22   │   # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span><br><span class="line">  23   │   - job_name: &apos;prometheusyl&apos;</span><br><span class="line">  24   │</span><br><span class="line">  25   │     # metrics_path defaults to &apos;/metrics&apos;        #metric的路径默认就是&apos;/metrics&apos;</span><br><span class="line">  26   │     # scheme defaults to &apos;http&apos;.</span><br><span class="line">  27   │</span><br><span class="line">  28   │     static_configs:                              </span><br><span class="line">  29   │         - targets: [&apos;10.239.157.138:7071&apos;]</span><br><span class="line">  30   │   - job_name: &apos;test-prometheus-from-yl&apos;           #1. 先设置job名</span><br><span class="line">  31   │</span><br><span class="line">  32   │     metrics_path: /                               #2. 可以自定义metric路径</span><br><span class="line">  33   │</span><br><span class="line">  34   │     static_configs:                               #3. 配置的方式，例如static，file</span><br><span class="line">  35   │         - targets: [&apos;10.239.157.141:8001&apos;]        #4. scrap目标来源，也就是将metric暴露给http的端口地址</span><br><span class="line">  36   │</span><br><span class="line">  37   │   - job_name: &apos;test_node_exporter&apos;</span><br><span class="line">  38   │</span><br><span class="line">  39   │     static_configs:</span><br><span class="line">  40   │         - targets: [&apos;10.239.157.129:9100&apos;]</span><br><span class="line">  41   │</span><br><span class="line">  42   │</span><br><span class="line">───────┴─────────────────────────────────────────────────────────────</span><br></pre></td></tr></table></figure></li></ul><h2 id="Exporte-local-metric-to-http-xxx-port-by-official-Node-Exporter-of-Prometheus"><a href="#Exporte-local-metric-to-http-xxx-port-by-official-Node-Exporter-of-Prometheus" class="headerlink" title="Exporte local metric to http:xxx:port by official Node Exporter of Prometheus"></a>Exporte local metric to http:xxx:port by official Node Exporter of Prometheus</h2><blockquote><p>OWCA is able to export metrics to file acceptable by node_exporter (with “textfile” collector enabled) – because we haven’t released owca-kafka-consumer yet (and we’re blocked because it has http endpoint and python server is not suitable for production usage), so before we publish it (that probably require rewrite to go and start new SDL process), the official way to getting data to Promethes is to use “LogStorage(overwrite=True, outputfile_name=’metrics.prom’)” with node_exporter  before Kubecon (ps. Kafka is still there for customer that need that) </p></blockquote><p><a href="https://github.com/prometheus/node_exporter" target="_blank" rel="noopener">https://github.com/prometheus/node_exporter</a></p><p>确定升级go version 到2.12xxx 不然build可能出错</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/prometheus/node_exporter</span><br><span class="line">cd $&#123;GOPATH-$HOME/go&#125;/src/github.com/prometheus/node_exporter</span><br><span class="line">make</span><br><span class="line">./node_exporter &lt;flags&gt;</span><br></pre></td></tr></table></figure><p>build完成之后</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./node_exporter --collector.textfile.directory  /home/li/myfolder/</span><br></pre></td></tr></table></figure><p>for example</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">li@yl-machine:~/Go/src/github.com/prometheus/node_exporter$ ./node_exporter --collector.textfile.directory /home/li/Go/test_node</span><br></pre></td></tr></table></figure><p>这里collector flag 设置为 textfile 这样可以load本地磁盘的文件</p><p>for example:</p><ul><li><p>Polan team OWCA monitor metrics to   <em>LogStorage(overwrite=True, outputfile_name=’metrics.prom’)</em>, 只要找到metric.prom 的local存储Path然后设置 <em>colletcor.textfile.directory</em> 为此Path 就可以源源不断将owca 暴露的数据push 到Promethus db</p></li><li><p>according to official example</p><ul><li><p>To atomically push completion time for a cron job:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo my_batch_job_completion_time $(date +%s) &gt; /path/to/directory/my_batch_job.prom.$$</span><br><span class="line">mv /path/to/directory/my_batch_job.prom.$$ /path/to/directory/my_batch_job.prom</span><br></pre></td></tr></table></figure></li><li><p>To statically set roles for a machine using labels:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;role&#123;role=&quot;application_server&quot;&#125; 1&apos; &gt; /path/to/directory/role.prom.$$</span><br><span class="line">mv /path/to/directory/role.prom.$$ /path/to/directory/role.prom</span><br></pre></td></tr></table></figure></li></ul></li><li><p>if we save the role.prom to test_node folder, then</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">li@yl-machine:~/Go/src/github.com/prometheus/node_exporter$ ./node_exporter --collector.textfile.directory /home/li/Go/test_node</span><br></pre></td></tr></table></figure><p>  输出:</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">INFO[0000] Starting node_exporter (version=0.17.0, branch=master, revision=4e5c4d464fa67e9cdfd9858d2151bc99603b2bff)  source=&quot;node_expor</span><br><span class="line">INFO[0000] Build context (go=go1.12.4, user=li@yl-machine, date=20190418-09:08:01)  source=&quot;node_exporter.go:157&quot;</span><br><span class="line">INFO[0000] Enabled collectors:                           source=&quot;node_exporter.go:97&quot;</span><br><span class="line">INFO[0000]  - arp                                        source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - bcache                                     source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - bonding                                    source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - conntrack                                  source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - cpu                                        source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - cpufreq                                    source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - diskstats                                  source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - edac                                       source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - entropy                                    source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - filefd                                     source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - filesystem                                 source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - hwmon                                      source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - infiniband                                 source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - ipvs                                       source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - loadavg                                    source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - mdadm                                      source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - meminfo                                    source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - netclass                                   source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - netdev                                     source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - netstat                                    source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - nfs                                        source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - nfsd                                       source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - sockstat                                   source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - stat                                       source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - textfile                                   source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - time                                       source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - timex                                      source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - uname                                      source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - vmstat                                     source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - xfs                                        source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000]  - zfs                                        source=&quot;node_exporter.go:104&quot;</span><br><span class="line">INFO[0000] Listening on :9100                            source=&quot;node_exporter.go:170&quot;</span><br></pre></td></tr></table></figure></li></ul><p>now open the brower 可以看出在9100端口 <a href="http://10.239.157.129:9100/metrics" target="_blank" rel="noopener">http://10.239.157.129:9100/metrics</a>, 在browser可看到之前写入的role metric 已经从本地prom file expose to http server</p><pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">process_virtual_memory_max_bytes -1</span><br><span class="line"># HELP promhttp_metric_handler_requests_in_flight Current number of scrapes being served.</span><br><span class="line"># TYPE promhttp_metric_handler_requests_in_flight gauge</span><br><span class="line">promhttp_metric_handler_requests_in_flight 1</span><br><span class="line"># HELP promhttp_metric_handler_requests_total Total number of scrapes by HTTP status code.</span><br><span class="line"># TYPE promhttp_metric_handler_requests_total counter</span><br><span class="line">promhttp_metric_handler_requests_total&#123;code=&quot;200&quot;&#125; 2</span><br><span class="line">promhttp_metric_handler_requests_total&#123;code=&quot;500&quot;&#125; 0</span><br><span class="line">promhttp_metric_handler_requests_total&#123;code=&quot;503&quot;&#125; 0</span><br><span class="line"># HELP role Metric read from /home/li/Go/test_node/role.prom</span><br><span class="line"># TYPE role untyped</span><br><span class="line">role&#123;role=&quot;application_server&quot;&#125; 1</span><br></pre></td></tr></table></figure></code></pre><p>这时候我们promtheous的configure file prometheus.yml 添加新的job-<em>target</em> 为<a href="http://10.239.157.129:9100" target="_blank" rel="noopener">http://10.239.157.129:9100</a><br>    就可以在Promethus的默认端口9090看到metric</p><pre><code>http://10.239.157.129:9090/graph</code></pre><h2 id="Prometheus-usage"><a href="#Prometheus-usage" class="headerlink" title="Prometheus usage"></a>Prometheus usage</h2><p>for example:</p><ul><li>the address  <a href="http://10.239.157.129:9090/graph" target="_blank" rel="noopener">http://10.239.157.129:9090/graph</a></li><li>see config <a href="http://10.239.157.129:9090/config" target="_blank" rel="noopener">http://10.239.157.129:9090/config</a></li><li>see target <a href="http://10.239.157.129:9090/targets" target="_blank" rel="noopener">http://10.239.157.129:9090/targets</a></li><li>show graph <a href="http://10.239.157.129:9090/graph" target="_blank" rel="noopener">http://10.239.157.129:9090/graph</a></li></ul><h2 id="Query-Promethus-data"><a href="#Query-Promethus-data" class="headerlink" title="Query Promethus data"></a>Query Promethus data</h2><ul><li>query all metric names</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response = requests.get(&apos;http://100.64.176.12:9090/api/v1/label/__name__/values&apos;)</span><br></pre></td></tr></table></figure><ul><li>query 1h data of matric</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res = requests.get(&apos;http://100.64.176.12:9090/api/v1/query&apos;,params=&#123;&apos;query&apos;: metrixName+&apos;[1h]&apos;&#125;)</span><br></pre></td></tr></table></figure><ul><li>get label series of a specific matric</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res = requests.get(&apos;http://100.64.176.12:9090/api/v1/series&apos;,params=&#123;&apos;match[]&apos;: metrixName&#125;)</span><br></pre></td></tr></table></figure><ul><li>query 1h data of specific matric and with specific label options</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res = requests.get(&apos;http://100.64.176.12:9090/api/v1/query&apos;,params=&#123;&apos;query&apos;: metrixName+&apos;&#123;&apos;+lablename+&apos;=&quot;&apos;+labelvalue+&apos;&quot;&#125;&apos;+&apos;[1h]&apos;&#125;)</span><br></pre></td></tr></table></figure><ul><li>query with <em>step</em> parameter, if (end-start)/step &gt; 110000, exceed the <em>maximum resolution</em> <a href="https://github.com/prometheus/prometheus/blob/91d7175eaac18b00e370965f3a8186cc40bf9f55/web/api/v1/api.go" target="_blank" rel="noopener">prometheus/web/api/v1/api.go</a>, prometheus will fail<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url = url + &apos;/api/v1/query_range&apos;</span><br><span class="line">params = &#123;&apos;query&apos;: query, &apos;start&apos;: start, &apos;end&apos;: end, &apos;step&apos;: step&#125;</span><br><span class="line">res = requests.get(url, params=params, timeout=timeout)</span><br></pre></td></tr></table></figure></li></ul><h2 id="Show-prometheus-in-Grafana"><a href="#Show-prometheus-in-Grafana" class="headerlink" title="Show prometheus in Grafana"></a>Show prometheus in Grafana</h2><p>grafana datasource add the url of prometheus</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Prometheus-start-by-docker&quot;&gt;&lt;a href=&quot;#Prometheus-start-by-docker&quot; class=&quot;headerlink&quot; title=&quot;Prometheus start by docker&quot;&gt;&lt;/a&gt;Promethe
      
    
    </summary>
    
    
      <category term="database" scheme="http://yoursite.com/tags/database/"/>
    
      <category term="prometheus" scheme="http://yoursite.com/tags/prometheus/"/>
    
      <category term="grafana" scheme="http://yoursite.com/tags/grafana/"/>
    
      <category term="time-series" scheme="http://yoursite.com/tags/time-series/"/>
    
  </entry>
  
  <entry>
    <title>Setting SSL for Zookeeper</title>
    <link href="http://yoursite.com/2019/06/21/zookeeper-ssl/"/>
    <id>http://yoursite.com/2019/06/21/zookeeper-ssl/</id>
    <published>2019-06-21T05:13:59.000Z</published>
    <updated>2019-06-21T09:38:36.131Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Reference-Links"><a href="#Reference-Links" class="headerlink" title="Reference Links"></a>Reference Links</h3><ul><li>Download from: <a href="https://archive.apache.org/dist/zookeeper/" target="_blank" rel="noopener">https://archive.apache.org/dist/zookeeper/</a>,  stable version <strong>not</strong> support ssl, so please download <em>zookeeper-3.5.0-alpha/</em></li><li>Zookeeper working with Kazoo: <a href="https://medium.com/@md.tsai/%E7%82%BA-zookeeper-%E8%A8%AD%E5%AE%9A%E5%8A%A0%E5%AF%86%E9%80%A3%E7%B7%9A-11702097f859" target="_blank" rel="noopener">https://medium.com/@md.tsai/%E7%82%BA-zookeeper-%E8%A8%AD%E5%AE%9A%E5%8A%A0%E5%AF%86%E9%80%A3%E7%B7%9A-11702097f859</a>, mainly refer this page</li><li>Official guide: <a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/ZooKeeper+SSL+User+Guide" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/ZOOKEEPER/ZooKeeper+SSL+User+Guide</a></li></ul><h3 id="Details-and-steps"><a href="#Details-and-steps" class="headerlink" title="Details and steps"></a>Details and steps</h3><h3 id="zookeeper-configure"><a href="#zookeeper-configure" class="headerlink" title="zookeeper configure"></a>zookeeper configure</h3><ul><li><p>start zookeeper <em>tar -zxvf zookeeper.tar.gz</em>, check status of  zookeeper by <em>bin/zkServer.sh status</em>, copy <em>conf/zoo.sample.cfg</em> to <em>conf/zoo.cfg</em>,zookeeper will auto read this file to start</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/zkServer.sh start</span><br></pre></td></tr></table></figure></li><li><p>test the connection of zookeeper works</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/zkCli.sh -server localhost:2181</span><br></pre></td></tr></table></figure></li></ul><h3 id="zookeeper-with-SSL"><a href="#zookeeper-with-SSL" class="headerlink" title="zookeeper with SSL"></a>zookeeper with SSL</h3><ul><li><p>setting env variable under <em>bin/zkEnv.sh</em></p><ul><li><p>comment out the origin line <em>export SERVER_JVMFLAGS ….</em></p></li><li><p>add this for the new line - for the zookeeper <strong>server</strong></p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ZK_SERVER_SSL=<span class="string">"-Dzookeeper.serverCnxnFactory=org.apache.zookeeper.server.NettyServerCnxnFactory</span></span><br><span class="line"><span class="string">-Dzookeeper.ssl.keyStore.location=/home/li/Documents/zoo-ssl/ssl-conf/keystore.jks </span></span><br><span class="line"><span class="string">-Dzookeeper.ssl.keyStore.password=yourpass</span></span><br><span class="line"><span class="string">-Dzookeeper.ssl.trustStore.location=/home/li/Documents/zoo-ssl/ssl-conf/keystore.jks</span></span><br><span class="line"><span class="string">-Dzookeeper.ssl.trustStore.password=yourpass"</span></span><br><span class="line"><span class="built_in">export</span> SERVER_JVMFLAGS=<span class="string">"-Xmx<span class="variable">$&#123;ZK_SERVER_HEAP&#125;</span>m <span class="variable">$ZK_SERVER_SSL</span> <span class="variable">$SERVER_JVMFLAGS</span>"</span></span><br></pre></td></tr></table></figure></li><li><p>comment out the origin line <em>export CLIENT_JVMFLAGS …</em></p></li><li><p>add this for the new line - for the zookeeper <strong>client</strong></p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ZK_CLIENT_SSL=<span class="string">"-Dzookeeper.serverCnxnFactory=org.apache.zookeeper.server.NettyServerCnxnFactory</span></span><br><span class="line"><span class="string">-Dzookeeper.ssl.keyStore.location=/home/li/Documents/zoo-ssl/ssl-conf/keystore.jks </span></span><br><span class="line"><span class="string">-Dzookeeper.ssl.keyStore.password=yourpass</span></span><br><span class="line"><span class="string">-Dzookeeper.ssl.trustStore.location=/home/li/Documents/zoo-ssl/ssl-conf/keystore.jks</span></span><br><span class="line"><span class="string">-Dzookeeper.ssl.trustStore.password=yourpass"</span></span><br><span class="line"><span class="built_in">export</span> CLIENT_JVMFLAGS=<span class="string">"-Xmx<span class="variable">$&#123;ZK_CLIENT_HEAP&#125;</span>m <span class="variable">$ZK_CLIENT_SSL</span> <span class="variable">$CLIENT_JVMFLAGS</span>"</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>add a <em>secureClientPort</em> for <em>conf/zoo.cfg</em></p><pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secureClientPort=2281</span><br></pre></td></tr></table></figure></code></pre></li><li><p>restart the zookeeper by</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/zkServer.sh restart</span><br></pre></td></tr></table></figure></li><li><p>test the connection by</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/zkCli.sh -server 127.0.0.1:2281</span><br></pre></td></tr></table></figure><p>  now we use the <strong>secureClientPort</strong> 2281</p></li></ul><h3 id="generate-keys-of-jks-and-pem-format"><a href="#generate-keys-of-jks-and-pem-format" class="headerlink" title="generate keys of jks and pem format"></a>generate keys of jks and pem format</h3><ul><li><p>generate keystore.jks example</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkeypair -<span class="built_in">alias</span> name1 -keyalg RSA -keysize 2048 -keypass password -storepass password -validity 9999 -keystore keystore.jks -ext SAN=DNS:localhost,IP:127.0.0.1</span><br><span class="line"></span><br><span class="line">keytool -genkeypair -<span class="built_in">alias</span> zookeeper-ssl -keyalg RSA -keysize 2048 -keypass aaaaaa -storepass yourpass -validity yourpass -keystore keystore.jks -ext SAN=DNS:localhost,IP:127.0.0.1</span><br></pre></td></tr></table></figure><p>  or enter password with interation</p>  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkey -keyalg RSA -<span class="built_in">alias</span> zookeeper-ssl -keystore keystore.jks -validity 9999 -keysize 2048</span><br></pre></td></tr></table></figure><p>  then you can use the zookeeper ssl with this key, the <em>keypass</em> and <em>storepass</em> should be same one, otherwise it will use the storepass.</p></li><li><p>Since kazoo don’t support jks, we need to transfer x.jks to x.pkcs12, then to the x.pem</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -importkeystore -srckeystore keystore.jks -destkeystore keystore.p12 -srcalias zookeeper-ssl -srcstoretype jks -deststoretype pkcs12</span><br></pre></td></tr></table></figure><p>  the source password is the password of x.jks, convert x.jks to x.pkcs12 by</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -importkeystore -srckeystore keystore.jks -destkeystore keystore.p12 -srcalias zookeeper-ssl -srcstoretype jks -deststoretype pkcs12</span><br></pre></td></tr></table></figure><p>  pay attention to the <em>srcalias</em></p><p>  convert x.pkcs12 to x.pem by</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -in keystore.p12 -out keystore.pem</span><br></pre></td></tr></table></figure></li><li><p>Kazoo : Kazoo implements the Zookeeper protocol in pure Python, so you don’t need any Python Zookeeper C bindings installed.</p><p>  <a href="https://kazoo.readthedocs.io/en/latest/api/client.html" target="_blank" rel="noopener">https://kazoo.readthedocs.io/en/latest/api/client.html</a></p></li></ul><pre><code><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zk = KazooClient(hosts=<span class="string">'IP:SEC_PORT'</span>, use_ssl=<span class="literal">True</span>, verify_certs=<span class="literal">False</span>, keyfile=<span class="string">'path/to/keystore.pem'</span>, certfile=<span class="string">'path/to/keystore.pem'</span>, keyfile_password=<span class="string">"password"</span>)</span><br></pre></td></tr></table></figure></code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Reference-Links&quot;&gt;&lt;a href=&quot;#Reference-Links&quot; class=&quot;headerlink&quot; title=&quot;Reference Links&quot;&gt;&lt;/a&gt;Reference Links&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Download fro
      
    
    </summary>
    
    
      <category term="zookeeper" scheme="http://yoursite.com/tags/zookeeper/"/>
    
      <category term="ssl" scheme="http://yoursite.com/tags/ssl/"/>
    
  </entry>
  
  <entry>
    <title>kafka</title>
    <link href="http://yoursite.com/2019/06/21/kafka/"/>
    <id>http://yoursite.com/2019/06/21/kafka/</id>
    <published>2019-06-21T05:13:49.000Z</published>
    <updated>2019-06-25T03:08:53.838Z</updated>
    
    <content type="html"><![CDATA[<h2 id="What-is-Kafaka"><a href="#What-is-Kafaka" class="headerlink" title="What is Kafaka"></a>What is Kafaka</h2><blockquote><p>Apache Kafka is an open-source stream-processing software platform developed by the Apache Software Foundation, written in Scala and Java. The project aims to provide a unified, high-throughput, low-latency platform for handling real-time data feeds. Its storage layer is essentially a “massively scalable pub/sub message queue architected as a distributed transaction log,” making it highly valuable for enterprise infrastructures to process streaming data. Additionally, Kafka connects to external systems (for data import/export) via Kafka Connect and provides Kafka Streams, a Java stream processing library. - wikipedia</p></blockquote><blockquote><p>先从数据库说起。<br>我们都知道，数据库中的数据，只要应用程序员不主动删除，就可以任意次读写，多少次都行。 数据库还对外提供了很漂亮的接口——SQL ——让程序员操作数据。<br>但是数据库不擅长做<em>通知</em>（人家也不是干这种事的）： 例如，程序A向数据库插入了一条数据， 然后程序B想知道这次数据更新，然后做点事情。<br>这种”通知”的事情，一种办法是用轮询实现， 程序B不断地查数据库，看看有没有新数据的到来， 但是这种方法效率很低。<br>更直接的办法是让应用程序之间直接交互，例如程序A调用程序B的RESTful API。<br>但问题是程序B如果暂时不可用，程序A就会比较悲催，怎么办呢？等一会儿再试？  如果程序B还不行，那就循环再试。 调用方的责任太大。<br>于是<em>消息队列(MQ)</em>就出现了，程序A把数据往消息队列中一扔，完事走人，程序B想什么时候读就什么时候读，极其灵活。<br>所以MQ的重要功能就是<em>解耦</em>，让两个系统可以独立运行，异步操作，互不影响。<br>MQ还有一个好处就是允许程序A疯狂地向其中放消息，程序B 可以慢悠悠地处理，这就起到了<em>消峰</em>的效果。<br>可是传统的MQ也有问题，通常情况下，一个消息确认被读取以后，就会被删除。 如果来了一个新的程序C，也想读之前的消息，或者说之前一段时间的消息，传统MQ表示无能无力。<br>能不能把数据库的特点和MQ的特点结合起来呢？<br>消息可以<em>持久化</em>，让多个程序都可以读取，并且还支持发布-订阅这种模式。<br>Kafka出现了，它也是一个消息队列，但是它能保存很长一段时间的消息（因为在硬盘上），队列中每个消息都有一个编号1,2,3,4….  ，这样就支持多个程序来读取。<br>只要记录下每个程序都读到了哪个<em>编号</em>， 这个程序可以断开和Kafka的连接，这个程序可以崩溃，下一次就可以接着读。<br>新的消费者程序可以随意加入读取，不影响其他消费者程序， 是不是很爽？<br>例如：程序B读到了编号为3的消息， 程序C读到了编号为5的消息， 这时候来了一个新的程序D，可以从头开始读。<br>这其实和数据库复制有点像：Kafka维护者“主数据库”， 每个消费者程序都是“从数据库”， 只要记住编号，消息都可以从“主数据库”复制到“从数据库”。<br>当然，Kafka做的远不止于此，它还充分利用硬盘顺序化读取速度快的特性，再加上分区，备份等高可用特性，  一个高吞吐量的分布式发布订阅消息系统就诞生了。  —— <a href="https://mp.weixin.qq.com/s/ghFDVMCacgYuTcG5klxTiw?" target="_blank" rel="noopener">来源</a></p></blockquote><blockquote><p>Every instance of Kafka that is responsible for message exchange is called a Broker.  – <a href="https://towardsdatascience.com/getting-started-with-apache-kafka-in-python-604b3250aa05" target="_blank" rel="noopener">source</a><br>每一个kafka实例（或者说每台kafka服务器节点）就是一个broker，一个broker可以有多个topic. –<a href="https://www.jianshu.com/p/1b657ac52f89" target="_blank" rel="noopener">来源</a></p></blockquote><h2 id="Kafka-Usage"><a href="#Kafka-Usage" class="headerlink" title="Kafka Usage"></a>Kafka Usage</h2><p><a href="https://kafka.apache.org/quickstart" target="_blank" rel="noopener">QuickStart</a></p><ul><li><p>start the server</p><ul><li><p>first start the zookeeper</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/zookeeper-server-start.sh config/zookeeper.properties</span><br></pre></td></tr></table></figure></li><li><p>then start the kafka</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-server-start.sh config/server.properties</span><br></pre></td></tr></table></figure></li></ul></li><li><p>stop the server</p><ul><li><p>first stop the kafka</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-server-stop.sh config/server.properties</span><br></pre></td></tr></table></figure></li><li><p>then start the zookeeper</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/zookeeper-server-stop.sh config/zookeeper.properties</span><br></pre></td></tr></table></figure><p>和start顺序相反</p></li></ul></li><li><p>new a topic </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh --create --bootstrap-server localhost:9092 --replication-factor 1 --partitions 1 --topic topic1</span><br></pre></td></tr></table></figure></li><li><p>list all the topic</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh --list --bootstrap-server localhost:9092</span><br></pre></td></tr></table></figure></li><li><p>describe topics</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh --zookeeper localhost:2181 --describe</span><br><span class="line">or</span><br><span class="line">bin/kafka-topics.sh --bootstrap-server localhost:9092 --describe</span><br></pre></td></tr></table></figure></li><li><p>start a producer </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-console-producer.sh --broker-list localhost:9092 --topic topic1</span><br></pre></td></tr></table></figure></li><li><p>start a consumer, read data from beginning</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic topic1 --from-beginning</span><br></pre></td></tr></table></figure></li><li><p>describe all the consumers</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --list</span><br></pre></td></tr></table></figure></li><li><p>describe broker</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh --describe --zookeeper localhost:2181 --topic topic1</span><br></pre></td></tr></table></figure></li><li><p>delete consumer group</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --delete --group console-consumer-44036</span><br></pre></td></tr></table></figure></li><li><p>show offset of current group</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --group console-consumer-59213 --describe</span><br></pre></td></tr></table></figure></li><li><p>produce under broker</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-console-producer.sh --broker-list localhost:9092 --topic topic1</span><br></pre></td></tr></table></figure></li></ul><h2 id="Experiment-on-kafka-retention-time-offset-and-group"><a href="#Experiment-on-kafka-retention-time-offset-and-group" class="headerlink" title="Experiment on kafka retention time, offset, and group"></a>Experiment on kafka retention time, offset, and group</h2><p>the retention time of Kafaka <em>Message</em> is configurable, the default retention of kafka is 7 days, <em>log.retention.hours = 168</em>, the priority of retention.ms, retention.minutes,retention.hours decrease progressively.</p><h3 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h3><p>During retention period, the message stored in disks, every consumer group can consume the message, if the retention period expired, neither consumer groups can consumer the message, the offset point to the end of the message queue.</p><p>During the retention period, if one message consumed by groupA, if groupA want to consum this message, it can’t, but if groupB did’t consume this message before, groupB can consume this message.</p><p>If a new message produced, the “log end offset” will plus one.</p><p>The current offset varies by differnt consumers, the consumer can user the <em>seek</em> function to consume any offset of messages, after the retention period, the current offset will point to the end, until new message comes.</p><h3 id="Experiment"><a href="#Experiment" class="headerlink" title="Experiment"></a>Experiment</h3><p>first we create a new topic time3min</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Downloads/kafka_2.11-2.0.0/bin$ ./kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic time3min</span><br></pre></td></tr></table></figure><p>then, alter the default retention time of time3min to 180000ms</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:~/Downloads/kafka_2.11-2.0.0/bin$ ./kafka-configs.sh --zookeeper localhost:2181 --alter --entity-name time3min --entity-type topics --add-config retention.ms=180000</span><br></pre></td></tr></table></figure><p>then we start a producer, produce some messages</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~/Downloads/kafka_2.11-2.0.0/bin$ ./kafka-console-producer.sh --broker-list localhost:9092 --topic time3min</span><br><span class="line">&gt;1</span><br><span class="line">&gt;2</span><br><span class="line">&gt;3</span><br><span class="line">&gt;4</span><br><span class="line">&gt;5</span><br><span class="line">&gt;6</span><br><span class="line">&gt;7</span><br></pre></td></tr></table></figure><p>within 3 min period, we start a consumer, set time to eraliest by <em>–from-beginning</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">:~/Downloads/kafka_2.11-2.0.0/bin$ ./kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic time3min --from-beginning</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">Processed a total of 7 messages</span><br></pre></td></tr></table></figure><p>after 3 mins, we create a new consumer, now we can’t consume any message</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">:~/Downloads/kafka_2.11-2.0.0/bin$ ./kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic time3min --from-beginning</span><br><span class="line">Processed a total of 0 messages</span><br></pre></td></tr></table></figure><p>then we produce some new message</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~/Downloads/kafka_2.11-2.0.0/bin$ ./kafka-console-producer.sh --broker-list localhost:9092 --topic time3min</span><br><span class="line">&gt;8-1</span><br><span class="line">&gt;8-2</span><br><span class="line">&gt;8-3</span><br></pre></td></tr></table></figure><p>then we start a new consumer, we can consume messages. but even we set –from-begining, the can only consume the messages within this 3 mins</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~/Downloads/kafka_2.11-2.0.0/bin$ ./kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic time3min --from-beginning</span><br><span class="line">8-1</span><br><span class="line">8-2</span><br><span class="line">8-3</span><br></pre></td></tr></table></figure><p>after 3min period, we can’t consume</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/Downloads/kafka_2.11-2.0.0/bin$ ./kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic time3min --from-beginning</span><br><span class="line">Processed a total of 0 messages</span><br></pre></td></tr></table></figure><p>then we continue to produce message</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~/Downloads/kafka_2.11-2.0.0/bin$ ./kafka-console-producer.sh --broker-list localhost:9092 --topic time3min</span><br><span class="line">&gt;9-1</span><br><span class="line">&gt;9-2</span><br><span class="line">&gt;9-3</span><br></pre></td></tr></table></figure><p>within 3mins, using group yi1 to consume data</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~/Downloads/kafka_2.11-2.0.0/bin$ ./kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic time3min --from-beginning --group yi1</span><br><span class="line">9-1</span><br><span class="line">9-2</span><br><span class="line">9-3</span><br><span class="line">Processed a total of 3 messages</span><br></pre></td></tr></table></figure><p>within 3mins, using group yi1 again to consume data</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/Downloads/kafka_2.11-2.0.0/bin$ ./kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic time3min --from-beginning --group yi1</span><br><span class="line">Processed a total of 0 messages</span><br></pre></td></tr></table></figure><p>then we use a new consumer group to consume message, we can consume messages</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~/Downloads/kafka_2.11-2.0.0/bin$ ./kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic time3min --from-beginning --group yi2</span><br><span class="line">9-1</span><br><span class="line">9-2</span><br><span class="line">9-3</span><br><span class="line">^CProcessed a total of 3 messages</span><br></pre></td></tr></table></figure><p>after 3mins, we use a new group yi3 to consume messages, no message</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">li@yl-machine:~/Downloads/kafka_2.11-2.0.0/bin$ ./kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic time3min --from-beginning --group yi3</span><br><span class="line">^CProcessed a total of 0 messages</span><br></pre></td></tr></table></figure><p>we can check the offset of yi3</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">:~/Downloads/kafka_2.11-2.0.0/bin$ ./kafka-consumer-groups.sh --bootstrap-server localhost:9092 --group yi3 --describe</span><br><span class="line">Consumer group &apos;yi3&apos; has no active members.</span><br><span class="line"></span><br><span class="line">TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID     HOST            CLIENT-ID</span><br><span class="line">time3min        0          15              15              0               -</span><br></pre></td></tr></table></figure><p>we use the producer to produce two new message, then check the offset of yi3</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~/Downloads/kafka_2.11-2.0.0/bin$ ./kafka-consumer-groups.sh --bootstrap-server localhost:9092 --group yi3 --describe</span><br><span class="line">Consumer group &apos;yi3&apos; has no active members.</span><br><span class="line"></span><br><span class="line">TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID     HOST            CLIENT-ID</span><br><span class="line">time3min        0          15              17              2               -               -               -</span><br></pre></td></tr></table></figure><p>when yi3 consume this 2 messages, offset point to end</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~/Downloads/kafka_2.11-2.0.0/bin$ ./kafka-console-consumer.sh –bootstrap-server localhost:9092 --topic time3min --from-beginning --group yi3</span><br><span class="line">99</span><br><span class="line">999</span><br><span class="line">^CProcessed a total of 2 messages</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~/Downloads/kafka_2.11-2.0.0/bin$ ./kafka-consumer-groups.sh --bootstrap-server localhost:9092 --group yi3 –describe</span><br><span class="line"></span><br><span class="line">Consumer group &apos;yi3&apos; has no active members.</span><br><span class="line"></span><br><span class="line">TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID     HOST            CLIENT-ID</span><br><span class="line">time3min        0          17              17              0               -               -               -</span><br></pre></td></tr></table></figure><h2 id="Message-ACK-and-Load-Balance"><a href="#Message-ACK-and-Load-Balance" class="headerlink" title="Message ACK and Load Balance"></a>Message ACK and Load Balance</h2><p><a href="https://www.jianshu.com/p/1b657ac52f89" target="_blank" rel="noopener">https://www.jianshu.com/p/1b657ac52f89</a></p><p><a href="https://kafka.apache.org/documentation/" target="_blank" rel="noopener">https://kafka.apache.org/documentation/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;What-is-Kafaka&quot;&gt;&lt;a href=&quot;#What-is-Kafaka&quot; class=&quot;headerlink&quot; title=&quot;What is Kafaka&quot;&gt;&lt;/a&gt;What is Kafaka&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Apache Ka
      
    
    </summary>
    
    
      <category term="kafka" scheme="http://yoursite.com/tags/kafka/"/>
    
      <category term="message queue" scheme="http://yoursite.com/tags/message-queue/"/>
    
      <category term="database" scheme="http://yoursite.com/tags/database/"/>
    
  </entry>
  
  <entry>
    <title>Hexo Start</title>
    <link href="http://yoursite.com/2019/06/21/hello-world/"/>
    <id>http://yoursite.com/2019/06/21/hello-world/</id>
    <published>2019-06-21T04:10:07.335Z</published>
    <updated>2019-06-21T07:13:06.253Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p><h1 id="Best-Manaual-I-Think"><a href="#Best-Manaual-I-Think" class="headerlink" title="Best Manaual I Think"></a>Best Manaual I Think</h1><p><a href="https://linghucong.js.org/2016/04/15/2016-04-15-hexo-github-pages-blog/" target="_blank" rel="noopener">手把手教你使用Hexo + Github Pages搭建个人独立博客</a></p><h1 id="Yilia-Theme"><a href="#Yilia-Theme" class="headerlink" title="Yilia Theme"></a>Yilia Theme</h1><p><a href="https://github.com/litten/hexo-theme-yilia" target="_blank" rel="noopener">Yilia github</a><br><a href="https://github.com/litten/BlogBackup" target="_blank" rel="noopener">Blog Backup</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
      <category term="start" scheme="http://yoursite.com/tags/start/"/>
    
      <category term="hexo" scheme="http://yoursite.com/tags/hexo/"/>
    
      <category term="yilia" scheme="http://yoursite.com/tags/yilia/"/>
    
  </entry>
  
</feed>
